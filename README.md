# Generation Toolchain for Protobuf
This repository provides a Dockerized toolchain for generating code and documentation from Protocol Buffers (protobuf) definitions, with first-class support for Go, gRPC, HTTP gateways, GraphQL, and API docs.

### What it includes
- Protobuf compiler (protoc) pinned to a specific version for reproducible builds.
- Go code generators:
    - protoc-gen-go for Go message types.
    - protoc-gen-go-grpc for gRPC service stubs.
    - protoc-gen-grpc-gateway for REST/HTTP JSON gateways from gRPC services.

- Documentation generators:
    - protoc-gen-doc for API documentation (supports formats like HTML/Markdown).
    - graphviz installed for diagram support in docs.

- GraphQL generator:
    - protoc-gen-gql (bundled via code_generator artifacts) to produce GraphQL schema and/or resolvers from protobuf and gRPC service definitions.

### Who itâ€™s for
- Teams building Go-based microservices with gRPC.
- Projects that need a single source of truth (protobuf) to generate multiple API surfaces (gRPC, REST, GraphQL).

### Project initialization

1. make install   (can ask for the password)
2. restart ( as recommended on first step finished)
3. make generate (to generate files from proto)

### Repository Structure

In general, every API has its own root directory,
and each major version of the API has its own subdirectory.

The proto package names exactly match the directory: this makes it easy to locate
the proto definitions and ensures that the generated client libraries have idiomatic
namespaces in most programming languages.

**NOTE:** The major version of an API is used to indicate breaking
change to the API.

### Common directories

./proto - All proto files by project name

./proto/common - common "objects", small object that used in 2 or more services

./proto/google - some google proto files that required for us services

./code_generator - files that require code generator scripts

## Conventions:

1. directory names should be snake_case
2. API methods (service) if folder contains only one service should be specified in file api.proto in CapitalisedCase, service name need to be
   ServiceProjectName, else if contains more than one service file name should be api_{service_name}.proto
   is recommended for documentation generation, api will be in first place
3. each project need to have ABOUT.md file for general description,
   when documentation is generated, content will be prepended to README.md file
4. README.md file is automatically generated, do not edit this file yourself.
   If you want to add something to documentation read previous point
5. All paths should be in snake_case, and packages name
6. version number in tags should be conformed to https://semver.org/
7. In each "project" in file api.proto, split service by base entity separated, to prevent "Fat interfaces",
   leave together only inheritance of base entity
8. Method names need to be "ActionEntity"  ex: GetAccount,
   Recommended to use terms from Recommended Actions,
   or add your action and definitions to Recommended Actions ,
   The verb portion of the method name should use the imperative mood,
   which is for orders or commands rather than the indicative mood which is for questions.
   For standard methods, the noun portion of the method name must be singular for all methods except List,
   and must be plural for List. For custom methods, the noun may be singular or plural as appropriate.
   Batch methods must use the plural noun.
9. Tags are allowed only for master branch, to use custom commits or branches see below ( Local Custom Build ).

### Recommended Actions

https://cloud.google.com/apis/design/naming_convention#method_names

1. Get - get one entity
2. List - get many entities
3. Create - create a new entity
4. Update - update existing entity
5. Upsert - update existing entity or create if it not exists
6. Delete - delete existing entity
7. Push - add element to list ( generally at end of list )
8. Pull - remove element from list
9. Import - add many entities from external source, like file
10. Export - return a file,stream, or something similar with serialized entities

### Documentation

documentation commentaries need to place:

1 for properties ABOVE declaration

```azure
message ProjectsResponse {
  // DOCUMENTATION
  repeated Project projects = 1;
}

```

2 for service methods ABOVE declaration, EX:

```azure
  // DOCUMENTATION
  rpc ClickRegister(RegisterTokenRequest) returns (RegisterResult){}

```

### Proto Lint and manuals

Checks and shows errors in the proto files

```commandline
make lint
```

Automatically fixes all possible errors, according to the official Style Guide.

```commandline
make fix
```

Official Protobuf style guide: https://developers.google.com/protocol-buffers/docs/style

Language Guide (proto 3)     https://protobuf.dev/programming-guides/proto3/

Proto Best Practices  https://protobuf.dev/programming-guides/dos-donts/

### Code Generation

Checks for errors with lint after that if there are no errors proceeds to generate code

```commandline

make generate

```

### GraphQl Schema generation

1. Setup in proto files for each method type of request (Query / Mutation )
3. To prevent "garbage methods" in graphql schema disable methods that not plain to use in frontend
3. Generate
4. Name convention: In query do not use "get" , "get_one", "get_list" or same

4. Example:

```azure
  import "danielvladco/protobuf/graphql.proto";

rpc ServiceStatus(google.protobuf.Empty) returns (Status){
        option (danielvladco.protobuf.graphql.rpc) = {
            type:QUERY, //available default is MUTATION
            ignore:false, // default value
            name:"Name in graph scheme" //default is service name + method name
        };
};
```

### Local Custom Build

to work with custom tag or branch run ( in related project):

```
go get -u https://github.com/becash/apis@<name branch>
```

to revert to "working tag" run ( in related project):

```
go get -u https://github.com/becash/apis
```

### Handling Version Downgrade
If a version downgrade is detected during the generation process, e.g.:

GRPC_GENERATED_VERSION changes from '1.65.5' to '1.65.4'

Follow these steps to resolve the issue:

1. Clean Docker environment: Run '*docker system prune -a*' to remove all unused Docker resources.

2. Re-run make generate: After cleaning the Docker environment, re-run the 'make generate' command to re-generate the gRPC code with the updated version.

This step is necessary to ensure that the generated code is consistent with the new version and to prevent potential conflicts. By following these steps, you should be able to successfully re-generate the gRPC code with the updated version.